name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  # --------------------
  # ðŸ§ª Unit Tests
  # --------------------
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Run Unit Tests
        run: ./gradlew testDebugUnitTest --stacktrace --info

      - name: Upload Unit Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: app/build/reports/tests/testDebugUnitTest/
          retention-days: 7

  # --------------------
  # ðŸ“± UI Tests on Emulator
  # --------------------
  ui-tests:
    name: UI Tests (Emulator)
    runs-on: macos-latest
    timeout-minutes: 60
    needs: [unit-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Build Debug APK
        run: ./gradlew assembleDebug assembleAndroidTest

      # ðŸ§© Pre-warm the Gradle daemon for emulator performance
      - name: Warm up Gradle
        run: ./gradlew help

      # âœ… Run tests in stable headless emulator environment
      - name: Run Instrumented Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 28
          target: google_apis
          arch: x86_64
          profile: Nexus 6
          script: |
            adb shell settings put global window_animation_scale 0
            adb shell settings put global transition_animation_scale 0
            adb shell settings put global animator_duration_scale 0

            echo "Granting permissions..."
            adb shell pm grant com.pennywise.app android.permission.INTERNET || true
            adb shell pm grant com.pennywise.app android.permission.ACCESS_NETWORK_STATE || true
            adb shell pm grant com.pennywise.app android.permission.READ_EXTERNAL_STORAGE || true
            adb shell pm grant com.pennywise.app android.permission.WRITE_EXTERNAL_STORAGE || true

            echo "Running connected tests..."
            ./gradlew connectedDebugAndroidTest -Pci=true --no-daemon --stacktrace --info
        continue-on-error: true

      - name: Upload UI Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-results
          path: app/build/reports/androidTests/connected/
          retention-days: 7

  # --------------------
  # ðŸ§° Accessibility Tests (optional)
  # --------------------
  accessibility-tests:
    name: Accessibility Tests
    runs-on: macos-latest
    timeout-minutes: 40
    needs: [unit-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Build for Accessibility Tests
        run: ./gradlew assembleDebug assembleAndroidTest

      - name: Run Accessibility Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: google_apis
          arch: x86_64
          ram-size: 4096M
          heap-size: 1024M
          disable-animations: true
          emulator-options: >-
            -no-snapshot -noaudio -no-boot-anim -gpu swiftshader_indirect
            -camera-back none -camera-front none -accel auto
            -memory 4096 -partition-size 8192
          script: |
            adb shell pm grant com.pennywise.app android.permission.INTERNET || true
            adb shell pm grant com.pennywise.app android.permission.ACCESS_NETWORK_STATE || true
            ./gradlew connectedDebugAndroidTest --tests "*AccessibilityTest*" -Pci=true --stacktrace
        continue-on-error: true

      - name: Upload Accessibility Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-test-results
          path: app/build/reports/androidTests/connected/
          retention-days: 7

  # --------------------
  # ðŸš€ Build & Deploy (main/master only)
  # --------------------
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: [unit-tests, ui-tests]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease --stacktrace

      - name: Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pennywise-release-apk
          path: app/build/outputs/apk/release/app-release-unsigned.apk
          retention-days: 30
